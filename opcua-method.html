<script type="text/javascript">
    RED.nodes.registerType('opcua-method', {
        category: 'opcuax',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            parentNodeId: { value: "" },
            nodeId: { value: "" },
            inputArguments: { value: [{ dataType: "str", value: "" }] },
        },
        inputs: 1,
        outputs: 1,
        icon: "opcua-logo.png",
        paletteLabel: "call",
        label: function () {
            return this.name || "call";
        },
        oneditprepare: function () {
            let node = this;
            console.log("Node: ", this.inputArguments);

            $("#node-input-inputArguments").css('height', 'auto').editableList({
                sortable: true,
                removable: true,
                addButton: "Add argument",
                addItem: function (container, i, data) {

                    if (!data || !data.dataType) {
                        data = { dataType: "str", value: "" };
                    }

                    var row = $('<div style="overflow: hidden; display: flex; align-items: center;"></div>').appendTo(container);

                    var valueInput = $('<input type="text" style="flex-grow: 1; margin-right: 5px;" class="node-input-value' + i + '">')
                        .appendTo(row)
                        .val(data.value)
                        .attr('placeholder', 'Value');

                    var position = $('<span style="margin-left: 5px;"> â†’ <span class="node-input-rule-index">' + i + '</span> </span>').appendTo(row);

                    var typeField = $('<input type="hidden" style="flex-grow: 1;" class="node-input-value-type' + i + '">').appendTo(row);
                    valueInput.typedInput({
                        type: data.dataType,
                        types: ["str", "num", "bool", "json"],
                        typeField: typeField,
                        onChange: function (type, value) {
                            data.dataType = type;
                            data.value = value;
                            $(container).find('.node-input-value' + i).attr('value', value);
                            $(container).find('.node-input-value-type' + i).attr('value', type);
                        }
                    });
                },
                removeItem: function (opt) {
                    var rules = $('#node-input-inputArguments').editableList('items');
                    rules.each(function (i) {
                        $(this).find('.node-input-rule-index').html(i);
                    });
                },
                sortItems: function () {
                    var rules = $('#node-input-inputArguments').editableList('items');
                    rules.each(function (i) {
                        $(this).find('.node-input-rule-index').html(i);
                    });
                }
            });

            // Check if node.inputArguments exists before using forEach
            if (node.inputArguments && Array.isArray(node.inputArguments) && node.inputArguments.length > 0) {
                node.inputArguments.forEach(function (arg) {
                    $("#node-input-inputArguments").editableList('addItem', arg);
                });
            }
        },
        oneditsave: function () {
            var inputArgs = $("#node-input-inputArguments").editableList('items');
            let node = this;
            node.inputArguments = [];
            inputArgs.each(function (i) {
                var valueNode = $(this).find('.node-input-value' + i);
                var value = valueNode.attr('value');

                var dataTypeNode = $(this).find('.node-input-value-type' + i);
                var dataType = dataTypeNode.attr('value');

                node.inputArguments.push({
                    value: value,
                    dataType: dataType
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="opcua-method">
    <div class="form-row">
        <label for="node-input-name"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-parentNodeId"><i class="fa fa-link"></i> Parent NodeId</label>
        <input type="text" id="node-input-parentNodeId" placeholder="ns=*;i=*, ns=*;s=*">
    </div>
    <div class="form-row">
        <label for="node-input-nodeId"><i class="fa fa-link"></i> NodeId</label>
        <input type="text" id="node-input-nodeId" placeholder="ns=*;i=*, ns=*;s=*">
    </div>

    <h4>Input Arguments</h4>
    <div class="form-row node-input-inputArguments-row">
        <ol id="node-input-inputArguments"></ol>
    </div>

    <h4>Output Arguments</h4>
    <div class="form-row">
        <div class="form-row node-input-property-container-row">
            <ol id="node-input-property-container"></ol>
        </div>
    </div>
</script>