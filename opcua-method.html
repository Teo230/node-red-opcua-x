<script type="text/javascript">
    RED.nodes.registerType('opcua-method', {
        category: 'opcuax',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            nodeId: { value: "" },
            inputArguments: { value: undefined },
            outputArguments: { value: undefined }
        },
        inputs: 1,
        outputs: 1,
        icon: "opcua-logo.png",
        paletteLabel: "call",
        label: function () {
            return this.name || "call";
        },
        oneditprepare: function () {
            let node = this;

            if (!node.inputArguments || node.inputArguments == undefined) {
                node.inputArguments = [{ dataType: "str", value: "" }];
            }

            if (!node.outputArguments ||node.outputArguments == undefined) {
                node.outputArguments = [{ dataType: "str", value: "" }];
            }

            //#region Input arguments table

            var inputArgumentsContainer = $("#node-input-inputArguments-container");
            inputArgumentsContainer.editableList({
                sortable: true,
                removable: true,
                scrollOnAdd: true,
                height: "auto",
                addButton: "Add argument",
                addItem: function (container, i, argument) {

                    var row = $('<div id="arg' + i + '" style="overflow: hidden; display: flex; align-items: center;"></div>').appendTo(container);

                    var valueInput = $('<input type="text" style="flex-grow: 1; margin-right: 5px;" class="node-input-value">')
                        .appendTo(row)
                        .val(argument.value)
                        .attr('placeholder', 'Value');

                    var position = $('<span style="margin-left: 5px;"> → <span class="node-input-inputArg-index">' + i + '</span> </span>').appendTo(row);

                    var typeField = $('<input type="hidden" style="flex-grow: 1;" class="node-input-value-type">').appendTo(row);
                    valueInput.typedInput({
                        type: argument.dataType,
                        types: ["str", "num", "bool"],
                        typeField: typeField,
                        onChange: function (dataType, value) {
                            argument.dataType = dataType;
                            argument.value = value;
                            $(container).find('#arg' + i).find('.node-input-value').attr('value', value);
                            $(container).find('#arg' + i).find('.node-input-value-type').attr('value', dataType);
                        }
                    });

                    var rowContainer = row.find('.red-ui-typedInput-container').css('flex-grow', 1);
                },
                removeItem: function (opt) {
                    var inputArgs = inputArgumentsContainer.editableList('items');
                    inputArgs.each(function (i) {
                        $(this).find('.node-input-inputArg-index').html(i);
                    });
                },
                sortItems: function () {
                    var inputArgs = inputArgumentsContainer.editableList('items');
                    inputArgs.each(function (i) {
                        var divIndex = $(this).find('.node-input-inputArg-index');
                        divIndex.html(i);
                        var row = divIndex.parent().parent();
                        row.attr('id', 'arg' + i);
                    });
                }
            });

            //#endregion

            //#region Output arguments table

            var outputArgumentsContainer = $("#node-input-outputArguments-container");
            outputArgumentsContainer.editableList({
                sortable: true,
                removable: true,
                scrollOnAdd: true,
                height: "auto",
                addButton: "Add argument",
                addItem: function (container, i, argument) {

                    var row = $('<div id="arg' + i + '" style="overflow: hidden; display: flex; align-items: center;"></div>').appendTo(container);

                    var valueInput = $('<input type="text" style="flex-grow: 1; margin-right: 5px;" class="node-input-value">')
                        .appendTo(row)
                        .val(argument.value)
                        .attr('placeholder', 'Value');

                    var position = $('<span style="margin-left: 5px;"> → <span class="node-input-outArg-index">' + i + '</span> </span>').appendTo(row);

                    var typeField = $('<input type="hidden" style="flex-grow: 1;" class="node-input-value-type">').appendTo(row);
                    valueInput.typedInput({
                        type: argument.dataType,
                        types: ["str", "num", "bool"],
                        typeField: typeField,
                        onChange: function (dataType, value) {
                            argument.dataType = dataType;
                            argument.value = value;
                            $(container).find('#arg' + i).find('.node-input-value').attr('value', value);
                            $(container).find('#arg' + i).find('.node-input-value-type').attr('value', dataType);
                        }
                    });

                    var rowContainer = row.find('.red-ui-typedInput-container').css('flex-grow', 1);
                },
                removeItem: function (opt) {
                    var outArgs = outputArgumentsContainer.editableList('items');
                    outArgs.each(function (i) {
                        $(this).find('.node-input-outArg-index').html(i);
                    });
                },
                sortItems: function () {
                    var outArgs = outputArgumentsContainer.editableList('items');
                    outArgs.each(function (i) {
                        var divIndex = $(this).find('.node-input-outArg-index');
                        divIndex.html(i);
                        var row = divIndex.parent().parent();
                        row.attr('id', 'arg' + i);
                    });
                }
            });

            //#endregion

            // Fill data
            (Array.isArray(node.inputArguments) ? node.inputArguments : []).forEach(function (arg) {
                inputArgumentsContainer.editableList('addItem', arg);
            });

            (Array.isArray(node.outputArguments) ? node.outputArguments : []).forEach(function (arg) {
                outputArgumentsContainer.editableList('addItem', arg);
            });
        },
        oneditsave: function () {

            let node = this;

            //#region Input arguments

            var inputArgContainer = $("#node-input-inputArguments-container");
            var inputArgs = inputArgContainer.editableList('items');
            node.inputArguments = [];
            inputArgs.each(function (index) {
                var row = inputArgContainer.find('#arg' + index);
                var value = row.find('.node-input-value').attr('value');
                var dataType = row.find('.node-input-value-type').attr('value');

                node.inputArguments.push({
                    value: value,
                    dataType: dataType
                });
            });

            //#endregion

            //#region Output arguments

            var outArgContainer = $("#node-input-outputArguments-container");
            var outputArgs = outArgContainer.editableList('items');
            node.outputArguments = [];
            outputArgs.each(function (index) {
                var row = outArgContainer.find('#arg' + index);
                var value = row.find('.node-input-value').attr('value');
                var dataType = row.find('.node-input-value-type').attr('value');

                node.outputArguments.push({
                    value: value,
                    dataType: dataType
                });
            });

            //#endregion
        }
    });
</script>

<script type="text/html" data-template-name="opcua-method">
    <div class="form-row">
        <label for="node-input-name"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-nodeId"><i class="fa fa-link"></i> NodeId</label>
        <input type="text" id="node-input-nodeId" placeholder="ns=*;i=*, ns=*;s=*">
    </div>

    <h4>Input Arguments</h4>
    <div class="form-row">
        <div class="form-row node-input-inputArguments-container-row">
            <ol id="node-input-inputArguments-container"></ol>
        </div>
    </div>

    <h4>Output Arguments</h4>
    <div class="form-row">
        <div class="form-row node-input-outputArguments-container-row">
            <ol id="node-input-outputArguments-container"></ol>
        </div>
    </div>
</script>