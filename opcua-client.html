<script type="text/javascript">
  RED.nodes.registerType("opcua-client", {
    category: "opcuax",
    color: "#a6bbcf",
    defaults: {
      name: { required: true },
      host: { required: true },
      securitypolicy: { value: "None", required: true },
      messagesecurity: { value: "None", required: true },
      anonymous: { value: true, required: false },
      username: {
        validate: function (v) {
          return $("#node-input-anonymous")[0]?.checked || v != "";
        },
      },
      password: {
        validate: function (v) {
          return $("#node-input-anonymous")[0]?.checked || v != "";
        },
      },
    },
    paletteLabel: "opcuax-client",
    inputs: 0,
    outputs: 1,
    icon: "opcua-logo.png",
    label: function () {
      return this.name || "opcuax-client";
    },
    oneditprepare: function () {
      $("#node-input-securitypolicy").typedInput({
        types: [
          {
            options: [
              { value: "None", label: "None" },
              { value: "Basic256", label: "Basic256" },
              { value: "Basic256Sha256", label: "Basic256Sha256" },
            ],
          },
        ],
      });

      $("#node-input-messagesecurity").typedInput({
        types: [
          {
            options: [
              { value: "None", label: "None" },
              { value: "Sign", label: "Sign" },
              { value: "SignAndEncrypt", label: "Sign&Encrypt" },
            ],
          },
        ],
      });

      $("#node-input-anonymous").on("change", function (event) {
        const value = $("#node-input-anonymous")[0].checked;
        $("#node-input-username")[0].readOnly = value;
        $("#node-input-password")[0].readOnly = value;
      });
    },
  });
</script>

<script type="text/html" data-help-name="opcua-client">
  <p>This node allows you to connect to an OPC UA server and interact with it.</p>
  <h3>Properties</h3>
  <ul>
    <li><b>Name</b>: The name of the node instance.</li>
    <li><b>Host</b>: The URL of the OPC UA server (e.g., opc.tcp://localhost:4840/).</li>
    <li><b>Security Policy</b>: The security policy to use for the connection. Options are:
      <ul>
        <li>None</li>
        <li>Basic256</li>
        <li>Basic256Sha256</li>
      </ul>
    </li>
    <li><b>Message Security Mode</b>: The message security mode to use. Options are:
      <ul>
        <li>None</li>
        <li>Sign</li>
        <li>Sign&Encrypt</li>
      </ul>
    </li>
    <li><b>Anonymous</b>: Whether to connect anonymously. If checked, username and password fields are disabled.</li>
    <li><b>Username</b>: The username for authentication (if not connecting anonymously).</li>
    <li><b>Password</b>: The password for authentication (if not connecting anonymously).</li>
  </ul>
  <h3>Usage</h3>
  <p>To use this node, drag it into your flow and configure the properties as needed. The node will connect to the specified OPC UA server and allow you to interact with it based on the configured settings.</p>
</script>

<script type="text/html" data-template-name="opcua-client">
  <div class="form-row">
      <label for="node-input-name"></i> Name</label>
      <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
      <label for="node-input-host"><i class="fa fa-server"></i> Host</label>
      <input type="text" id="node-input-host" placeholder="opc.tcp://localhost:4840/">
  </div>
  <h4>Authentication Settings</h4>
  <div class="form-row">
      <label for="node-input-securitypolicy"><i class="fa fa-lock"></i> Security Policy</label>
      <input type="text" id="node-input-securitypolicy">
  </div>
  <div class="form-row">
      <label for="node-input-messagesecurity"><i class="fa fa-envelope"></i> Message Security Mode</label>
      <input type="text" id="node-input-messagesecurity">
  </div>
  <div class="form-row">
      <label for="node-input-anonymous">Anonymous</label>
      <input type="checkbox" id="node-input-anonymous" style="margin: 5px 0px; width: auto;">
  </div>
  <div class="form-row">
      <label for="node-input-username">Username</label>
      <input type="text" id="node-input-username">
  </div>
  <div class="form-row">
      <label for="node-input-password">Password</label>
      <input type="password" id="node-input-password">
  </div>
</script>
